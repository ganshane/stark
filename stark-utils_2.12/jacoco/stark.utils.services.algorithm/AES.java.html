<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AES.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Stark Utils Support</a> &gt; <a href="index.source.html" class="el_package">stark.utils.services.algorithm</a> &gt; <span class="el_source">AES.java</span></div><h1>AES.java</h1><pre class="source lang-java linenums">// Copyright 2015,2016 the original author or authors. All rights reserved.
// site: http://www.ganshane.com
package stark.utils.services.algorithm;

import java.util.Random;

/**
 * @author &lt;a href=&quot;mailto:jcai@ganshane.com&quot;&gt;Jun Tsai&lt;/a&gt;
 * @since 2015-02-02
 */
public class AES {
    String key;//密钥
    int round;//加密轮数

    public AES() {
<span class="nc" id="L16">        super();</span>
<span class="nc" id="L17">        this.key = key();</span>
<span class="nc" id="L18">        this.round = new Random().nextInt(100);</span>
<span class="nc" id="L19">    }</span>

    public AES(String key, int round) {
<span class="nc" id="L22">        super();</span>
<span class="nc" id="L23">        this.key = key;</span>
<span class="nc" id="L24">        this.round = round;</span>
<span class="nc" id="L25">    }</span>

    //S盒
<span class="nc" id="L28">    static final String[][] Sbox = {</span>
            {&quot;63&quot;, &quot;7c&quot;, &quot;77&quot;, &quot;7b&quot;, &quot;f2&quot;, &quot;6b&quot;, &quot;6f&quot;, &quot;c5&quot;, &quot;30&quot;, &quot;01&quot;, &quot;67&quot;, &quot;2b&quot;, &quot;fe&quot;, &quot;d7&quot;, &quot;ab&quot;, &quot;76&quot;},
            {&quot;ca&quot;, &quot;82&quot;, &quot;c9&quot;, &quot;7d&quot;, &quot;fa&quot;, &quot;59&quot;, &quot;47&quot;, &quot;f0&quot;, &quot;ad&quot;, &quot;d4&quot;, &quot;a2&quot;, &quot;af&quot;, &quot;9c&quot;, &quot;a4&quot;, &quot;72&quot;, &quot;c0&quot;},
            {&quot;b7&quot;, &quot;fd&quot;, &quot;93&quot;, &quot;26&quot;, &quot;36&quot;, &quot;3f&quot;, &quot;f7&quot;, &quot;cc&quot;, &quot;34&quot;, &quot;a5&quot;, &quot;e5&quot;, &quot;f1&quot;, &quot;71&quot;, &quot;d8&quot;, &quot;31&quot;, &quot;15&quot;},
            {&quot;04&quot;, &quot;c7&quot;, &quot;23&quot;, &quot;c3&quot;, &quot;18&quot;, &quot;96&quot;, &quot;05&quot;, &quot;9a&quot;, &quot;07&quot;, &quot;12&quot;, &quot;80&quot;, &quot;e2&quot;, &quot;eb&quot;, &quot;27&quot;, &quot;b2&quot;, &quot;75&quot;},
            {&quot;09&quot;, &quot;83&quot;, &quot;2c&quot;, &quot;1a&quot;, &quot;1b&quot;, &quot;6e&quot;, &quot;5a&quot;, &quot;a0&quot;, &quot;52&quot;, &quot;3b&quot;, &quot;d6&quot;, &quot;b3&quot;, &quot;29&quot;, &quot;e3&quot;, &quot;2f&quot;, &quot;84&quot;},
            {&quot;53&quot;, &quot;d1&quot;, &quot;00&quot;, &quot;ed&quot;, &quot;20&quot;, &quot;fc&quot;, &quot;b1&quot;, &quot;5b&quot;, &quot;6a&quot;, &quot;cb&quot;, &quot;be&quot;, &quot;39&quot;, &quot;4a&quot;, &quot;4c&quot;, &quot;58&quot;, &quot;cf&quot;},
            {&quot;d0&quot;, &quot;ef&quot;, &quot;aa&quot;, &quot;fb&quot;, &quot;43&quot;, &quot;4d&quot;, &quot;33&quot;, &quot;85&quot;, &quot;45&quot;, &quot;f9&quot;, &quot;02&quot;, &quot;7f&quot;, &quot;50&quot;, &quot;3c&quot;, &quot;9f&quot;, &quot;a8&quot;},
            {&quot;51&quot;, &quot;a3&quot;, &quot;40&quot;, &quot;8f&quot;, &quot;92&quot;, &quot;9d&quot;, &quot;38&quot;, &quot;f5&quot;, &quot;bc&quot;, &quot;b6&quot;, &quot;da&quot;, &quot;21&quot;, &quot;10&quot;, &quot;ff&quot;, &quot;f3&quot;, &quot;d2&quot;},
            {&quot;cd&quot;, &quot;0c&quot;, &quot;13&quot;, &quot;ec&quot;, &quot;5f&quot;, &quot;97&quot;, &quot;44&quot;, &quot;17&quot;, &quot;c4&quot;, &quot;a7&quot;, &quot;7e&quot;, &quot;3d&quot;, &quot;64&quot;, &quot;5d&quot;, &quot;19&quot;, &quot;73&quot;},
            {&quot;60&quot;, &quot;81&quot;, &quot;4f&quot;, &quot;dc&quot;, &quot;22&quot;, &quot;2a&quot;, &quot;90&quot;, &quot;88&quot;, &quot;46&quot;, &quot;ee&quot;, &quot;b8&quot;, &quot;14&quot;, &quot;de&quot;, &quot;5e&quot;, &quot;0b&quot;, &quot;db&quot;},
            {&quot;e0&quot;, &quot;32&quot;, &quot;3a&quot;, &quot;0a&quot;, &quot;49&quot;, &quot;06&quot;, &quot;24&quot;, &quot;5c&quot;, &quot;c2&quot;, &quot;d3&quot;, &quot;ac&quot;, &quot;62&quot;, &quot;91&quot;, &quot;95&quot;, &quot;e4&quot;, &quot;79&quot;},
            {&quot;e7&quot;, &quot;c8&quot;, &quot;37&quot;, &quot;6d&quot;, &quot;8d&quot;, &quot;d5&quot;, &quot;4e&quot;, &quot;a9&quot;, &quot;6c&quot;, &quot;56&quot;, &quot;f4&quot;, &quot;ea&quot;, &quot;65&quot;, &quot;7a&quot;, &quot;ae&quot;, &quot;08&quot;},
            {&quot;ba&quot;, &quot;78&quot;, &quot;25&quot;, &quot;2e&quot;, &quot;1c&quot;, &quot;a6&quot;, &quot;b4&quot;, &quot;c6&quot;, &quot;e8&quot;, &quot;dd&quot;, &quot;74&quot;, &quot;1f&quot;, &quot;4b&quot;, &quot;bd&quot;, &quot;8b&quot;, &quot;8a&quot;},
            {&quot;70&quot;, &quot;3e&quot;, &quot;b5&quot;, &quot;66&quot;, &quot;48&quot;, &quot;03&quot;, &quot;f6&quot;, &quot;0e&quot;, &quot;61&quot;, &quot;35&quot;, &quot;57&quot;, &quot;b9&quot;, &quot;86&quot;, &quot;c1&quot;, &quot;1d&quot;, &quot;9e&quot;},
            {&quot;e1&quot;, &quot;f8&quot;, &quot;98&quot;, &quot;11&quot;, &quot;69&quot;, &quot;d9&quot;, &quot;8e&quot;, &quot;94&quot;, &quot;9b&quot;, &quot;1e&quot;, &quot;87&quot;, &quot;e9&quot;, &quot;ce&quot;, &quot;55&quot;, &quot;28&quot;, &quot;df&quot;},
            {&quot;8c&quot;, &quot;a1&quot;, &quot;89&quot;, &quot;0d&quot;, &quot;bf&quot;, &quot;e6&quot;, &quot;42&quot;, &quot;68&quot;, &quot;41&quot;, &quot;99&quot;, &quot;2d&quot;, &quot;0f&quot;, &quot;b0&quot;, &quot;54&quot;, &quot;bb&quot;, &quot;16&quot;}
    };
    //逆S盒
<span class="nc" id="L47">    static final String[][] InvSbox = {</span>
            {&quot;52&quot;, &quot;09&quot;, &quot;6a&quot;, &quot;d5&quot;, &quot;30&quot;, &quot;36&quot;, &quot;a5&quot;, &quot;38&quot;, &quot;bf&quot;, &quot;40&quot;, &quot;a3&quot;, &quot;9e&quot;, &quot;81&quot;, &quot;f3&quot;, &quot;d7&quot;, &quot;fb&quot;},
            {&quot;7c&quot;, &quot;e3&quot;, &quot;39&quot;, &quot;82&quot;, &quot;9b&quot;, &quot;2f&quot;, &quot;ff&quot;, &quot;87&quot;, &quot;34&quot;, &quot;8e&quot;, &quot;43&quot;, &quot;44&quot;, &quot;c4&quot;, &quot;de&quot;, &quot;e9&quot;, &quot;cb&quot;},
            {&quot;54&quot;, &quot;7b&quot;, &quot;94&quot;, &quot;32&quot;, &quot;a6&quot;, &quot;c2&quot;, &quot;23&quot;, &quot;3d&quot;, &quot;ee&quot;, &quot;4c&quot;, &quot;95&quot;, &quot;0b&quot;, &quot;42&quot;, &quot;fa&quot;, &quot;c3&quot;, &quot;4e&quot;},
            {&quot;08&quot;, &quot;2e&quot;, &quot;a1&quot;, &quot;66&quot;, &quot;28&quot;, &quot;d9&quot;, &quot;24&quot;, &quot;b2&quot;, &quot;76&quot;, &quot;5b&quot;, &quot;a2&quot;, &quot;49&quot;, &quot;6d&quot;, &quot;8b&quot;, &quot;d1&quot;, &quot;25&quot;},
            {&quot;72&quot;, &quot;f8&quot;, &quot;f6&quot;, &quot;64&quot;, &quot;86&quot;, &quot;68&quot;, &quot;98&quot;, &quot;16&quot;, &quot;d4&quot;, &quot;a4&quot;, &quot;5c&quot;, &quot;cc&quot;, &quot;5d&quot;, &quot;65&quot;, &quot;b6&quot;, &quot;92&quot;},
            {&quot;6c&quot;, &quot;70&quot;, &quot;48&quot;, &quot;50&quot;, &quot;fd&quot;, &quot;ed&quot;, &quot;b9&quot;, &quot;da&quot;, &quot;5e&quot;, &quot;15&quot;, &quot;46&quot;, &quot;57&quot;, &quot;a7&quot;, &quot;8d&quot;, &quot;9d&quot;, &quot;84&quot;},
            {&quot;90&quot;, &quot;d8&quot;, &quot;ab&quot;, &quot;00&quot;, &quot;8c&quot;, &quot;bc&quot;, &quot;d3&quot;, &quot;0a&quot;, &quot;f7&quot;, &quot;e4&quot;, &quot;58&quot;, &quot;05&quot;, &quot;b8&quot;, &quot;b3&quot;, &quot;45&quot;, &quot;06&quot;},
            {&quot;d0&quot;, &quot;2c&quot;, &quot;1e&quot;, &quot;8f&quot;, &quot;ca&quot;, &quot;3f&quot;, &quot;0f&quot;, &quot;02&quot;, &quot;c1&quot;, &quot;af&quot;, &quot;bd&quot;, &quot;03&quot;, &quot;01&quot;, &quot;13&quot;, &quot;8a&quot;, &quot;6b&quot;},
            {&quot;3a&quot;, &quot;91&quot;, &quot;11&quot;, &quot;41&quot;, &quot;4f&quot;, &quot;67&quot;, &quot;dc&quot;, &quot;ea&quot;, &quot;97&quot;, &quot;f2&quot;, &quot;cf&quot;, &quot;ce&quot;, &quot;f0&quot;, &quot;b4&quot;, &quot;e6&quot;, &quot;73&quot;},
            {&quot;96&quot;, &quot;ac&quot;, &quot;74&quot;, &quot;22&quot;, &quot;e7&quot;, &quot;ad&quot;, &quot;35&quot;, &quot;85&quot;, &quot;e2&quot;, &quot;f9&quot;, &quot;37&quot;, &quot;e8&quot;, &quot;1c&quot;, &quot;75&quot;, &quot;df&quot;, &quot;6e&quot;},
            {&quot;47&quot;, &quot;f1&quot;, &quot;1a&quot;, &quot;71&quot;, &quot;1d&quot;, &quot;29&quot;, &quot;c5&quot;, &quot;89&quot;, &quot;6f&quot;, &quot;b7&quot;, &quot;62&quot;, &quot;0e&quot;, &quot;aa&quot;, &quot;18&quot;, &quot;be&quot;, &quot;1b&quot;},
            {&quot;fc&quot;, &quot;56&quot;, &quot;3e&quot;, &quot;4b&quot;, &quot;c6&quot;, &quot;d2&quot;, &quot;79&quot;, &quot;20&quot;, &quot;9a&quot;, &quot;db&quot;, &quot;c0&quot;, &quot;fe&quot;, &quot;78&quot;, &quot;cd&quot;, &quot;5a&quot;, &quot;f4&quot;},
            {&quot;1f&quot;, &quot;dd&quot;, &quot;a8&quot;, &quot;33&quot;, &quot;88&quot;, &quot;07&quot;, &quot;c7&quot;, &quot;31&quot;, &quot;b1&quot;, &quot;12&quot;, &quot;10&quot;, &quot;59&quot;, &quot;27&quot;, &quot;80&quot;, &quot;ec&quot;, &quot;5f&quot;},
            {&quot;60&quot;, &quot;51&quot;, &quot;7f&quot;, &quot;a9&quot;, &quot;19&quot;, &quot;b5&quot;, &quot;4a&quot;, &quot;0d&quot;, &quot;2d&quot;, &quot;e5&quot;, &quot;7a&quot;, &quot;9f&quot;, &quot;93&quot;, &quot;c9&quot;, &quot;9c&quot;, &quot;ef&quot;},
            {&quot;a0&quot;, &quot;e0&quot;, &quot;3b&quot;, &quot;4d&quot;, &quot;ae&quot;, &quot;2a&quot;, &quot;f5&quot;, &quot;b0&quot;, &quot;c8&quot;, &quot;eb&quot;, &quot;bb&quot;, &quot;3c&quot;, &quot;83&quot;, &quot;53&quot;, &quot;99&quot;, &quot;61&quot;},
            {&quot;17&quot;, &quot;2b&quot;, &quot;04&quot;, &quot;7e&quot;, &quot;ba&quot;, &quot;77&quot;, &quot;d6&quot;, &quot;26&quot;, &quot;e1&quot;, &quot;69&quot;, &quot;14&quot;, &quot;63&quot;, &quot;55&quot;, &quot;21&quot;, &quot;0c&quot;, &quot;7d&quot;}

    };

    //字节代替
    public char[] subBytes(char[] state) {
<span class="nc" id="L69">        char[] result = new char[state.length];</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        for (int i = 0; i &lt; state.length; i++) {</span>
<span class="nc" id="L71">            String s = Integer.toHexString(state[i]);</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">            if (s.length() &lt; 2) {</span>
<span class="nc" id="L73">                s = &quot;0&quot; + s;</span>
            }
<span class="nc bnc" id="L75" title="All 4 branches missed.">            String rs = Sbox[s.charAt(0) &lt; 97 ? s.charAt(0) - 48 : s.charAt(0) - 87][s.charAt(1) &lt; 97 ? s.charAt(1) - 48 : s.charAt(1) - 87];</span>
<span class="nc" id="L76">            result[i] = (char) Integer.parseInt(rs, 16);</span>
        }
<span class="nc" id="L78">        return result;</span>
    }

    //逆字节代替
    public char[] invSubBytes(char[] state) {
<span class="nc" id="L83">        char[] result = new char[16];</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        for (int i = 0; i &lt; state.length; i++) {</span>
<span class="nc" id="L85">            String s = Integer.toHexString(state[i]);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            if (s.length() &lt; 2) {</span>
<span class="nc" id="L87">                s = &quot;0&quot; + s;</span>
            }
<span class="nc bnc" id="L89" title="All 4 branches missed.">            String rs = InvSbox[s.charAt(0) &lt; 97 ? s.charAt(0) - 48 : s.charAt(0) - 87][s.charAt(1) &lt; 97 ? s.charAt(1) - 48 : s.charAt(1) - 87];</span>
<span class="nc" id="L90">            result[i] = (char) Integer.parseInt(rs, 16);</span>
        }
<span class="nc" id="L92">        return result;</span>
    }

    //列混淆
    public char[] mixColumns(char[] state) {
<span class="nc" id="L97">        char[] lisa = {2, 3, 1, 1};</span>
<span class="nc" id="L98">        char[] result = new char[16];</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">        for (int col = 0; col &lt; 4; col++) {</span>
<span class="nc" id="L100">            char[] lisb = new char[4];</span>
<span class="nc" id="L101">            int flagc = col;</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            for (int m = 0; m &lt; 4; m++) {</span>
<span class="nc" id="L103">                lisb[m] = state[flagc];</span>
<span class="nc" id="L104">                flagc += 4;</span>
            }
<span class="nc bnc" id="L106" title="All 2 branches missed.">            for (int row = 0; row &lt; 4; row++) {</span>
<span class="nc" id="L107">                int k = ffmul(lisb[0], lisa[(4 - row) % 4]) ^ ffmul(lisb[1], lisa[(5 - row) % 4]) ^ ffmul(lisb[2], lisa[(6 - row) % 4]) ^ ffmul(lisb[3], lisa[(7 - row) % 4]);</span>
<span class="nc" id="L108">                result[row * 4 + col] = (char) k;</span>
            }
        }
<span class="nc" id="L111">        return result;</span>
    }

    //逆列混淆
    public char[] invMixColumns(char[] state) {
<span class="nc" id="L116">        char[] lisa = {14, 11, 13, 9};</span>
<span class="nc" id="L117">        char[] result = new char[16];</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        for (int col = 0; col &lt; 4; col++) {</span>
<span class="nc" id="L119">            char[] lisb = new char[4];</span>
<span class="nc" id="L120">            int flagc = col;</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            for (int m = 0; m &lt; 4; m++) {</span>
<span class="nc" id="L122">                lisb[m] = state[flagc];</span>
<span class="nc" id="L123">                flagc += 4;</span>
            }
<span class="nc bnc" id="L125" title="All 2 branches missed.">            for (int row = 0; row &lt; 4; row++) {</span>
<span class="nc" id="L126">                int k = ffmul(lisb[0], lisa[(4 - row) % 4]) ^ ffmul(lisb[1], lisa[(5 - row) % 4]) ^ ffmul(lisb[2], lisa[(6 - row) % 4]) ^ ffmul(lisb[3], lisa[(7 - row) % 4]);</span>
<span class="nc" id="L127">                result[row * 4 + col] = (char) k;</span>
            }
        }
<span class="nc" id="L130">        return result;</span>
    }

    //字节乘法
    public int ffmul(int a, int b) {
<span class="nc" id="L135">        String ba = Integer.toBinaryString(a);</span>
<span class="nc" id="L136">        int[] stor = new int[8];</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        while (ba.length() &lt; 8) {</span>
<span class="nc" id="L138">            ba = &quot;0&quot; + ba;</span>
        }
<span class="nc" id="L140">        stor[0] = b;</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        for (int i = 1; i &lt; 8; i++) {</span>
<span class="nc" id="L142">            String bb = Integer.toBinaryString(stor[i - 1]);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (bb.length() &lt; 8) {</span>
<span class="nc" id="L144">                stor[i] = leftshift(stor[i - 1], 1);</span>
            } else
<span class="nc" id="L146">                stor[i] = leftshift(stor[i - 1], 1) ^ 27;</span>
        }
<span class="nc" id="L148">        int result = 0;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        for (int i = 7; i &gt;= 0; i--) {</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">            if (ba.charAt(i) == '1') {</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                if (result == 0) {</span>
<span class="nc" id="L152">                    result = stor[7 - i];</span>
                } else
<span class="nc" id="L154">                    result = result ^ stor[7 - i];</span>
            }
        }
<span class="nc" id="L157">        return result;</span>
    }

    //二进制数左移
    public int leftshift(int num, int step) {
<span class="nc" id="L162">        String ba = Integer.toBinaryString(num);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        while (ba.length() &lt; 8) {</span>
<span class="nc" id="L164">            ba = &quot;0&quot; + ba;</span>
        }
<span class="nc bnc" id="L166" title="All 2 branches missed.">        for (int i = 0; i &lt; step; i++) {</span>
<span class="nc" id="L167">            ba += &quot;0&quot;;</span>
        }
<span class="nc" id="L169">        return Integer.parseInt(ba.substring(step), 2);</span>
    }

    //行移位
    public char[] shiftRows(char[] state) {
<span class="nc" id="L174">        char[][] in = new char[4][4];</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            for (int j = 0; j &lt; 4; j++) {</span>
<span class="nc" id="L177">                in[i][j] = state[i * 4 + j];</span>
            }
        }
<span class="nc" id="L180">        char[] result = new char[16];</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            for (int j = 0; j &lt; 4; j++) {</span>
<span class="nc" id="L183">                result[i * 4 + j] = in[i][(j + i) % 4];</span>
            }
        }
<span class="nc" id="L186">        return result;</span>
    }

    //逆行移位
    public char[] invShiftRows(char[] state) {
<span class="nc" id="L191">        char[][] in = new char[4][4];</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">            for (int j = 0; j &lt; 4; j++) {</span>
<span class="nc" id="L194">                in[i][j] = state[i * 4 + j];</span>
            }
        }
<span class="nc" id="L197">        char[] result = new char[16];</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">            for (int j = 0; j &lt; 4; j++) {</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">                int col = (j - i) &gt; 0 ? (j - i) : (j - i) + 4;</span>
<span class="nc" id="L201">                result[i * 4 + j] = in[i][col % 4];</span>
            }
        }
<span class="nc" id="L204">        return result;</span>
    }

    //轮密钥加
    public char[] addRoundKey(char[] state, char[] key) {
<span class="nc" id="L209">        char[] result = new char[16];</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">        for (int col = 0; col &lt; 4; col++) {</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            for (int row = 0; row &lt; 4; row++) {</span>
<span class="nc" id="L212">                result[row * 4 + col] = (char) (state[row * 4 + col] ^ key[row * 4 + col]);</span>
            }
        }
<span class="nc" id="L215">        return result;</span>
    }

    //密钥扩展
    public char[][] keyExpansion(char[] key, int round) {
<span class="nc" id="L220">        char[] RC = new char[round];</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">        for (int i = 0; i &lt; round; i++) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">            if (i == 0) {</span>
<span class="nc" id="L223">                RC[i] = 1;</span>
            } else {
<span class="nc" id="L225">                RC[i] = (char) ffmul(2, RC[i - 1]);</span>
            }
        }

<span class="nc" id="L229">        char[][] newkey = new char[round][16];</span>
<span class="nc" id="L230">        char[] start = {key[12], key[13], key[14], key[15]};</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">        for (int r = 0; r &lt; round; r++) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            for (int i = 3; i &lt; 7; i++) {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                if (i == 3) {</span>
<span class="nc" id="L234">                    char ot = start[0];</span>
<span class="nc" id="L235">                    start[0] = start[1];</span>
<span class="nc" id="L236">                    start[1] = start[2];</span>
<span class="nc" id="L237">                    start[2] = start[3];</span>
<span class="nc" id="L238">                    start[3] = ot;//RotWord()</span>
<span class="nc" id="L239">                    start = subBytes(start);</span>
<span class="nc" id="L240">                    start = XOR(start, new char[]{RC[r], 0, 0, 0});</span>
                }
<span class="nc" id="L242">                char[] last = {key[(i - 3) * 4], key[(i - 3) * 4 + 1], key[(i - 3) * 4 + 2], key[(i - 3) * 4 + 3]};</span>
<span class="nc" id="L243">                start = XOR(start, last);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                for (int k = 0; k &lt; 4; k++) {</span>
<span class="nc" id="L245">                    key[(i - 3) * 4 + k] = start[k];</span>
                }
<span class="nc bnc" id="L247" title="All 2 branches missed.">                for (int j = 0; j &lt; 4; j++) {</span>
<span class="nc" id="L248">                    newkey[r][(i + 1) % 4 + j * 4] = start[j];</span>
                }
            }
        }
<span class="nc" id="L252">        return newkey;</span>
    }

    //异或
    public char[] XOR(char[] a, char[] b) {
<span class="nc" id="L257">        char[] result = new char[a.length];</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        for (int i = 0; i &lt; a.length; i++) {</span>
<span class="nc" id="L259">            result[i] = (char) (((int) a[i]) ^ ((int) b[i]));</span>
        }
<span class="nc" id="L261">        return result;</span>
    }

    //字节加密
    public char[] cipher(char[] in, char[] key, int round) {
<span class="nc" id="L266">        char[] out = new char[16];</span>
<span class="nc" id="L267">        char[] newword = new char[16];</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        for (int i = 0; i &lt; 16; i++) {</span>
<span class="nc" id="L269">            newword[i] = key[i];</span>
        }
<span class="nc" id="L271">        char[][] keys = keyExpansion(newword, round);</span>
<span class="nc" id="L272">        in = exchange(in);</span>
<span class="nc" id="L273">        key = exchange(key);</span>
<span class="nc" id="L274">        in = addRoundKey(in, key);</span>

<span class="nc bnc" id="L276" title="All 2 branches missed.">        for (int i = 0; i &lt; round - 1; i++) {</span>
<span class="nc" id="L277">            out = subBytes(in);</span>
<span class="nc" id="L278">            out = shiftRows(out);</span>
<span class="nc" id="L279">            out = mixColumns(out);</span>
<span class="nc" id="L280">            in = addRoundKey(out, keys[i]);</span>
        }
<span class="nc" id="L282">        out = subBytes(in);</span>
<span class="nc" id="L283">        out = shiftRows(out);</span>
<span class="nc" id="L284">        out = addRoundKey(out, keys[round - 1]);</span>
<span class="nc" id="L285">        return exchange(out);</span>
    }

    //字符串加密
    public String cipher(String in, String key, int round) {
<span class="nc" id="L290">        StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L291">        char[] keys = Tools.hexStr2Cs(key);</span>
<span class="nc" id="L292">        String hexStr = Tools.Str2hexStr(in);</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        while (hexStr.length() &gt;= 32) {</span>
<span class="nc" id="L294">            String sin = hexStr.substring(0, 32);</span>
<span class="nc" id="L295">            hexStr = hexStr.substring(32);</span>
<span class="nc" id="L296">            sb.append(Tools.Cs2hexStr(cipher(Tools.hexStr2Cs(sin), keys, round)));</span>
<span class="nc" id="L297">        }</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (hexStr.length() &gt; 0) {</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            while (hexStr.length() &lt; 32) {</span>
<span class="nc" id="L300">                hexStr += &quot;0&quot;;</span>
            }
<span class="nc" id="L302">            sb.append(Tools.Cs2hexStr(cipher(Tools.hexStr2Cs(hexStr), keys, round)));</span>
        }
<span class="nc" id="L304">        return sb.toString();</span>
    }

    public String cipher(String in) {
<span class="nc" id="L308">        return cipher(in, this.key, this.round);</span>
    }

    //字节解密
    public char[] inCipher(char[] in, char[] key, int round) {
<span class="nc" id="L313">        char[] out = new char[16];</span>
<span class="nc" id="L314">        char[] newword = new char[16];</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">        for (int i = 0; i &lt; 16; i++) {</span>
<span class="nc" id="L316">            newword[i] = key[i];</span>
        }
<span class="nc" id="L318">        char[][] keys = keyExpansion(newword, round);</span>
<span class="nc" id="L319">        in = exchange(in);</span>
<span class="nc" id="L320">        key = exchange(key);</span>
<span class="nc" id="L321">        in = addRoundKey(in, keys[round - 1]);</span>

<span class="nc bnc" id="L323" title="All 2 branches missed.">        for (int i = 0; i &lt; round - 1; i++) {</span>
<span class="nc" id="L324">            out = invShiftRows(in);</span>
<span class="nc" id="L325">            out = invSubBytes(out);</span>
<span class="nc" id="L326">            out = addRoundKey(out, keys[round - 2 - i]);</span>
<span class="nc" id="L327">            in = invMixColumns(out);</span>

        }
<span class="nc" id="L330">        out = invShiftRows(in);</span>
<span class="nc" id="L331">        out = invSubBytes(out);</span>
<span class="nc" id="L332">        out = addRoundKey(out, key);</span>
<span class="nc" id="L333">        return exchange(out);</span>
    }

    //字符串解密
    public String inCipher(String in, String key, int round) {
<span class="nc" id="L338">        StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L339">        char[] keys = Tools.hexStr2Cs(key);</span>
<span class="nc" id="L340">        String hexStr = in;//Str2hexStr(in);</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">        while (hexStr.length() &gt;= 32) {</span>
<span class="nc" id="L342">            String sin = hexStr.substring(0, 32);</span>
<span class="nc" id="L343">            hexStr = hexStr.substring(32);</span>
<span class="nc" id="L344">            sb.append(Tools.hexStr2Str(Tools.Cs2hexStr(inCipher(Tools.hexStr2Cs(sin), keys, round))));</span>
<span class="nc" id="L345">        }</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">        if (hexStr.length() &gt; 0) {</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">            while (hexStr.length() &lt; 32) {</span>
<span class="nc" id="L348">                hexStr += &quot;0&quot;;</span>
            }
<span class="nc" id="L350">            sb.append(Tools.hexStr2Str(Tools.Cs2hexStr(inCipher(Tools.hexStr2Cs(hexStr), keys, round))));</span>
        }
<span class="nc bnc" id="L352" title="All 2 branches missed.">        while (sb.charAt(sb.length() - 1) == 0) {</span>
<span class="nc" id="L353">            sb = sb.deleteCharAt(sb.length() - 1);</span>
        }
<span class="nc" id="L355">        return sb.toString();</span>
    }

    public String inCipher(String in) {
<span class="nc" id="L359">        return inCipher(in, this.key, this.round);</span>
    }

    //行列变换
    public char[] exchange(char[] chars) {
<span class="nc" id="L364">        char[] nchars = new char[chars.length];</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">            for (int j = 0; j &lt; 4; j++) {</span>
<span class="nc" id="L367">                nchars[i * 4 + j] = chars[j * 4 + i];</span>
            }
        }
<span class="nc" id="L370">        return nchars;</span>
    }

    public static void print(String s, char[] chars) {
<span class="nc" id="L374">        System.out.println(s + &quot; &quot;);</span>
<span class="nc" id="L375">        String[] sts = Tools.Cs2Ss(chars);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">        for (int i = 0; i &lt; sts.length; i++) {</span>
<span class="nc" id="L377">            System.out.print(sts[i] + &quot; &quot;);</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">            if (i % 4 == 3) {</span>
<span class="nc" id="L379">                System.out.println();</span>
            }
        }
<span class="nc" id="L382">        System.out.println();</span>
<span class="nc" id="L383">    }</span>

    //密钥生成器
    public String key() {
<span class="nc" id="L387">        StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L388">        Random r = new Random();</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">        for (int i = 0; i &lt; 8; i++) {</span>
<span class="nc" id="L390">            sb.append((char) r.nextInt(65535));</span>
        }
<span class="nc" id="L392">        return Tools.Str2hexStr(sb.toString());</span>
    }

    public static void main(String[] args) {
<span class="nc" id="L396">        AES aes = new AES();</span>
<span class="nc" id="L397">        String cstring = &quot;大家,， 爱上对方&quot;;</span>
        //String cword = &quot;2b7e151628aed2a6abf7158809cf4f3c&quot;;
<span class="nc" id="L399">        String cword = aes.key();</span>
<span class="nc" id="L400">        String mw = aes.cipher(cstring);</span>
<span class="nc" id="L401">        System.out.println(&quot;密文:    &quot; + mw);</span>
<span class="nc" id="L402">        String result1 = aes.inCipher(mw);</span>
<span class="nc" id="L403">        System.out.println(result1);</span>
<span class="nc" id="L404">        System.out.println(&quot;密钥:    &quot; + cword);</span>
<span class="nc" id="L405">    }</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>